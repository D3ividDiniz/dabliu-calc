<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Financeira Pro (HP-12C Style)</title>
    <style>
        /* 1. Reset e Configura√ß√µes Globais */
        :root {
            --font-main: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            
            /* Light Theme */
            --bg-color-light: #F4F6F9;
            --surface-color-light: #FFFFFF;
            --calculator-body-light: #EAEAEA;
            --text-color-light: #121212;
            --text-muted-light: #555;
            --border-color-light: #D1D1D1;

            /* Dark Theme */
            --bg-color-dark: #121212;
            --surface-color-dark: #1E1E1E;
            --calculator-body-dark: #2A2A2A;
            --text-color-dark: #E0E0E0;
            --text-muted-dark: #888;
            --border-color-dark: #3A3A3A;

            /* Cores HP-12C */
            --hp-gold: #D4AF37;
            --hp-blue: #007bff;
            --hp-orange: #FFA500;
            --hp-dark-grey: #333333;
            --hp-black: #000000;
        }

        body {
            font-family: var(--font-main);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
            background-color: var(--bg-color-light);
            color: var(--text-color-light);
        }
        body.dark-mode {
            background-color: var(--bg-color-dark);
            color: var(--text-color-dark);
        }

        /* 2. Layout da Calculadora */
        .calculator-wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 420px;
            margin: 20px;
            background: var(--calculator-body-light);
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color-light);
            padding: 20px;
        }
        body.dark-mode .calculator-wrapper {
            background: var(--calculator-body-dark);
            border-color: var(--border-color-dark);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        
        /* 3. Header e Theme Toggle */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .app-header h1 {
            font-size: 1.4em;
            margin: 0;
            font-weight: 600;
        }
        /* Theme Toggle Switch (c√≥digo id√™ntico ao anterior) */
        .theme-switch-wrapper { display: flex; align-items: center; gap: 8px; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 44px; }
        .theme-switch input { display: none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 24px; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--hp-blue); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* 4. Display da Calculadora */
        .display-area {
            background-color: var(--hp-dark-grey);
            border: 2px solid var(--hp-black);
            border-radius: 4px;
            padding: 5px;
            margin-bottom: 20px;
        }
        .display {
            background-color: #C1C6AD; /* Cor do LCD da HP12C */
            color: var(--hp-black);
            border-radius: 3px;
            padding: 10px;
            text-align: right;
        }
        .display-context {
            font-family: monospace;
            font-size: 0.9em;
            min-height: 18px;
            opacity: 0.7;
        }
        .display-main {
            font-family: 'Segment7', monospace;
            font-size: 2.2em;
            font-weight: bold;
            min-height: 45px;
            word-wrap: break-word;
        }
        @font-face {
            font-family: 'Segment7';
            src: url(https://dl.dafont.com/dl/?f=open_24_display_st) format('truetype');
        }

        /* 5. Grid de Bot√µes Reorganizado */
        .button-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 8px;
        }
        .calc-button {
            padding: 8px 4px;
            font-size: 0.85em;
            font-weight: bold;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.2);
            border-bottom: 2px solid rgba(0,0,0,0.4);
            background-color: var(--hp-dark-grey);
            color: white;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 50px;
        }
        .calc-button:active {
            transform: translateY(1px);
            border-bottom-width: 1px;
        }

        /* Labels de fun√ß√£o (f, g) */
        .f-label { color: var(--hp-orange); font-size: 0.65em; position: absolute; top: 3px; left: 4px; }
        .g-label { color: var(--hp-blue); font-size: 0.65em; position: absolute; top: 3px; right: 4px; }
        .main-label { font-size: 1.1em; }
        
        /* Estilos de Bot√µes Espec√≠ficos */
        .btn-prefix-f { background-color: var(--hp-orange); }
        .btn-prefix-g { background-color: var(--hp-blue); }
        .btn-enter { grid-row: span 2; }
        .btn-arithmetic { background-color: #555; }
        .btn-on { background: #B22222; grid-column: span 2; }
        
        /* 6. Responsividade */
        @media (max-width: 480px) {
            .calculator-wrapper { padding: 15px; margin: 10px; }
            .button-grid { gap: 6px; }
            .calc-button { min-height: 45px; }
            .app-header h1 { font-size: 1.2em; }
        }

    </style>
</head>
<body>
    <div class="calculator-wrapper">
        <header class="app-header">
            <h1>HP-12C Web</h1>
            <div class="theme-switch-wrapper">
                <span>‚òÄÔ∏è</span>
                <label class="theme-switch">
                    <input type="checkbox" id="theme-toggle">
                    <span class="slider"></span>
                </label>
                <span>üåô</span>
            </div>
        </header>

        <div class="display-area">
            <div class="display">
                <div class="display-context" id="display-context">&nbsp;</div>
                <div class="display-main" id="display-main">0</div>
            </div>
        </div>
        
        <div class="button-grid">
            <button class="calc-button" data-key="n" data-g-key="AMORT"><span class="f-label">n</span><span class="g-label">AMORT</span><span class="main-label">12x</span></button>
            <button class="calc-button" data-key="i" data-g-key="INT"><span class="f-label">i</span><span class="g-label">INT</span><span class="main-label">12√∑</span></button>
            <button class="calc-button" data-key="PV" data-g-key="NPV"><span class="f-label">PV</span><span class="g-label">NPV</span><span class="main-label">CFo</span></button>
            <button class="calc-button" data-key="PMT" data-g-key="RND"><span class="f-label">PMT</span><span class="g-label">RND</span><span class="main-label">CFj</span></button>
            <button class="calc-button" data-key="FV" data-g-key="IRR"><span class="f-label">FV</span><span class="g-label">IRR</span><span class="main-label">Nj</span></button>
            <button class="calc-button" data-key="CHS"><span class="f-label">CHS</span></button>
            <button class="calc-button" data-key="7"><span class="f-label">7</span></button>
            <button class="calc-button" data-key="8"><span class="f-label">8</span></button>
            <button class="calc-button" data-key="9"><span class="f-label">9</span></button>
            <button class="calc-button btn-arithmetic" data-key="/"><span class="main-label">√∑</span></button>

            <button class="calc-button" data-key="yx" data-g-key="PRICE"><span class="f-label">y^x</span><span class="g-label">PRICE</span><span class="main-label">‚àöx</span></button>
            <button class="calc-button" data-key="1/x" data-g-key="YTM"><span class="f-label">1/x</span><span class="g-label">YTM</span><span class="main-label">%T</span></button>
            <button class="calc-button" data-key="%" data-g-key="SL"><span class="f-label">%</span><span class="g-label">SL</span><span class="main-label">Œî%</span></button>
            <button class="calc-button" data-key="EEX" data-g-key="SOYD"><span class="f-label">EEX</span><span class="g-label">SOYD</span><span class="main-label">n!</span></button>
            <button class="calc-button" data-key="R/S" data-g-key="DB"><span class="f-label">R/S</span><span class="g-label">DB</span><span class="main-label">‚û§</span></button>
            <button class="calc-button" data-key="SST"><span class="f-label">SST</span></button>
            <button class="calc-button" data-key="4"><span class="f-label">4</span></button>
            <button class="calc-button" data-key="5"><span class="f-label">5</span></button>
            <button class="calc-button" data-key="6"><span class="f-label">6</span></button>
            <button class="calc-button btn-arithmetic" data-key="*"><span class="main-label">√ó</span></button>

            <button class="calc-button btn-on" data-key="AC">ON</button>
            <button class="calc-button btn-prefix-f" data-key="f">f</button>
            <button class="calc-button btn-prefix-g" data-key="g">g</button>
            <button class="calc-button btn-enter" data-key="Enter"><span class="main-label">ENTER</span></button>
            <button class="calc-button" data-key="1"><span class="f-label">1</span></button>
            <button class="calc-button" data-key="2"><span class="f-label">2</span></button>
            <button class="calc-button" data-key="3"><span class="f-label">3</span></button>
            <button class="calc-button btn-arithmetic" data-key="-"><span class="main-label">‚àí</span></button>
            
            <button class="calc-button" data-key="STO"><span class="f-label">STO</span><span class="g-label">LN</span></button>
            <button class="calc-button" data-key="RCL"><span class="f-label">RCL</span><span class="g-label">e^x</span></button>
            <button class="calc-button" data-key="CLx"><span class="g-label">CLx</span></button>
            <button class="calc-button" data-key="0"><span class="f-label">0</span></button>
            <button class="calc-button" data-key="."><span class="f-label">.</span></button>
            <button class="calc-button" data-key="Œ£+"><span class="f-label">Œ£+</span></button>
            <button class="calc-button btn-arithmetic" data-key="+"><span class="main-label">+</span></button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Mapeamento do DOM e Estado Inicial
        const dom = {
            displayMain: document.getElementById('display-main'),
            displayContext: document.getElementById('display-context'),
            themeToggle: document.getElementById('theme-toggle'),
            buttons: document.querySelectorAll('.calc-button'),
        };

        let state = {
            currentValue: '0',
            previousValue: null,
            operator: null,
            isNewEntry: true,
            prefix: null, // 'f' or 'g'
            registers: { n: null, i: null, PV: null, PMT: null, FV: null },
            memory: new Array(10).fill(null), // STO/RCL memory registers 0-9
        };
        
        // --- M√ìDULO DE TEMA ---
        const themeManager = (() => {
            // (C√≥digo id√™ntico ao anterior, funciona perfeitamente)
            const body = document.body;
            const applyTheme = (theme) => {
                if (theme === 'dark') {
                    body.classList.add('dark-mode');
                    dom.themeToggle.checked = true;
                } else {
                    body.classList.remove('dark-mode');
                    dom.themeToggle.checked = false;
                }
            };
            const toggleTheme = () => {
                const newTheme = body.classList.contains('dark-mode') ? 'light' : 'dark';
                applyTheme(newTheme);
                localStorage.setItem('calculatorTheme', newTheme);
            };
            const loadTheme = () => {
                const savedTheme = localStorage.getItem('calculatorTheme') || 'light';
                applyTheme(savedTheme);
            };
            return { init: loadTheme, toggle: toggleTheme };
        })();
        
        // --- M√ìDULO DE C√ÅLCULO FINANCEIRO E MATEM√ÅTICO ---
        const engine = {
            solveTVM: (solveFor, { n, i, PV, PMT, FV }) => {
                // Assume 0 for null values, except for the one being solved
                n = (solveFor !== 'n' && n === null) ? 0 : n;
                i = (solveFor !== 'i' && i === null) ? 0 : i;
                PV = (solveFor !== 'PV' && PV === null) ? 0 : PV;
                PMT = (solveFor !== 'PMT' && PMT === null) ? 0 : PMT;
                FV = (solveFor !== 'FV' && FV === null) ? 0 : FV;

                i = i / 100; // Work with decimal interest
                if (i === 0) {
                     switch (solveFor) {
                        case 'PV': return -(FV + PMT * n);
                        case 'FV': return -(PV + PMT * n);
                        case 'PMT': return -(PV + FV) / n;
                        case 'n': return PMT !== 0 ? -(PV + FV) / PMT : null;
                        default: return null;
                     }
                }
                const factor = Math.pow(1 + i, n);
                switch (solveFor) {
                    case 'FV': return -(PV * factor + PMT * (factor - 1) / i);
                    case 'PV': return -(FV / factor + PMT * (1 - Math.pow(1 + i, -n)) / i);
                    case 'PMT': return -(PV * factor + FV) / ((factor - 1) / i);
                    case 'n':
                        const logNumerator = -(FV + PMT / i);
                        const logDenominator = PV + PMT / i;
                        if (logNumerator <= 0 || logDenominator <= 0) return null;
                        return Math.log(logNumerator / logDenominator) / Math.log(1 + i);
                    // 'i' requires iterative solver, omitted for brevity in this step
                }
                return null;
            },
            factorial: (num) => {
                if (num < 0) return NaN;
                if (num === 0) return 1;
                let result = 1;
                for (let i = 2; i <= num; i++) result *= i;
                return result;
            },
            depreciationSL: (cost, salvage, life) => (cost - salvage) / life,
            depreciationDB: (cost, salvage, life, period) => {
                // Factor can be adjusted, 200% is common (factor=2)
                const factor = 2;
                const rate = factor / life;
                let bookValue = cost;
                for (let i = 0; i < period; i++) {
                    const depr = bookValue * rate;
                    bookValue -= depr;
                    if (bookValue < salvage) bookValue = salvage;
                }
                return bookValue;
            }
        };

        // --- M√ìDULO DE ATUALIZA√á√ÉO DO DISPLAY ---
        const updateDisplay = {
            main: (value = state.currentValue) => {
                let [integerPart, decimalPart] = String(value).split('.');
                if (String(value).length > 12) {
                    integerPart = parseFloat(value).toExponential(5);
                    decimalPart = undefined;
                }
                const formattedInteger = parseFloat(integerPart).toLocaleString('pt-BR', {maximumFractionDigits: 10});
                dom.displayMain.textContent = decimalPart !== undefined ? `${formattedInteger},${decimalPart}` : formattedInteger;
            },
            context: () => {
                let contextStr = '';
                if (state.prefix) {
                    contextStr += `<span style="color: var(--hp-${state.prefix === 'f' ? 'orange' : 'blue'}); font-weight: bold;">${state.prefix}</span> `;
                }
                // Adicionar outros indicadores de status aqui se necess√°rio
                dom.displayContext.innerHTML = contextStr || '&nbsp;';
            }
        };

        // --- L√ìGICA PRINCIPAL DA CALCULADORA ---
        const handleInput = (key, gKey) => {
            if (state.prefix) {
                key = (state.prefix === 'g' && gKey) ? gKey : key; // Use gKey if available for g-prefix
                handleFunction(key);
                state.prefix = null; // Reset prefix after use
                updateDisplay.context();
                return;
            }
            if (/\d/.test(key)) handleNumber(key);
            else if (key === '.') handleDecimal();
            else if (['+', '-', '*', '/'].includes(key)) handleOperator(key);
            else if (['n', 'i', 'PV', 'PMT', 'FV'].includes(key)) handleTVM(key);
            else {
                handleFunction(key);
            }
        };
        
        const handleNumber = (number) => {
            if (state.isNewEntry) {
                state.currentValue = number;
                state.isNewEntry = false;
            } else {
                if(state.currentValue === '0') state.currentValue = number;
                else state.currentValue += number;
            }
            updateDisplay.main();
        };

        const handleDecimal = () => {
            if (state.isNewEntry) {
                state.currentValue = '0.';
                state.isNewEntry = false;
            } else if (!state.currentValue.includes('.')) {
                state.currentValue += '.';
            }
            updateDisplay.main();
        };

        const handleOperator = (op) => {
            // Simplified algebraic operation for now
            if (!state.isNewEntry) {
                 if (state.previousValue !== null && state.operator) {
                    const current = parseFloat(state.currentValue);
                    let result;
                    switch(state.operator) {
                        case '+': result = state.previousValue + current; break;
                        case '-': result = state.previousValue - current; break;
                        case '*': result = state.previousValue * current; break;
                        case '/': result = state.previousValue / current; break;
                    }
                    state.currentValue = String(result);
                }
                state.previousValue = parseFloat(state.currentValue);
                state.isNewEntry = true;
            }
            state.operator = op;
        };

        const handleTVM = (key) => {
            if (!state.isNewEntry) { // If there's a number in display, store it
                state.registers[key] = parseFloat(state.currentValue);
                state.isNewEntry = true; // Ready for next number or computation
                alert(`${key} armazenado como ${state.registers[key]}`);
            } else { // No new number, so compute the key
                const result = engine.solveTVM(key, state.registers);
                if (result !== null && !isNaN(result)) {
                    const roundedResult = parseFloat(result.toFixed(4));
                    state.registers[key] = roundedResult;
                    state.currentValue = String(roundedResult);
                    updateDisplay.main();
                    alert(`${key} calculado: ${roundedResult}`);
                } else {
                    alert(`N√£o foi poss√≠vel calcular ${key}. Verifique os valores inseridos.`);
                }
            }
        };

        const handleFunction = (key) => {
            const value = parseFloat(state.currentValue);
            let result = value;

            switch (key) {
                case 'f':
                case 'g':
                    state.prefix = key;
                    updateDisplay.context();
                    return; // Don't reset newEntry
                case 'AC': // ON/Clear
                    state = { ...state, currentValue: '0', previousValue: null, operator: null, isNewEntry: true, registers: { n: null, i: null, PV: null, PMT: null, FV: null }};
                    break;
                case 'CLx': // Clear entry
                    state.currentValue = '0';
                    state.isNewEntry = true;
                    break;

                // Math functions
                case 'CHS': result = value * -1; break;
                case '1/x': result = 1 / value; break;
                case '‚àöx': result = Math.sqrt(value); break;
                case 'n!': result = engine.factorial(value); break;
                case 'LN': result = Math.log(value); break;
                case 'e^x': result = Math.exp(value); break;
                case 'yx': // Requires RPN stack, simplified here
                    state.previousValue = value;
                    state.operator = '^';
                    state.isNewEntry = true;
                    return;
                
                // Memory
                case 'STO':
                case 'RCL':
                    state.prefix = key; // Wait for a number key
                    alert(`Pressione uma tecla de 0 a 9 para ${key === 'STO' ? 'armazenar' : 'recuperar'}.`);
                    return;

                // Placeholder for unimplemented functions
                case 'AMORT': case 'INT': case 'NPV': case 'RND': case 'IRR': case 'PRICE': case 'YTM': case 'SL': case 'SOYD': case 'DB':
                    alert(`Fun√ß√£o "${key}" ainda n√£o implementada.`);
                    break;
            }
            
            state.currentValue = String(result);
            updateDisplay.main();
            state.isNewEntry = true;
        };

        const handleMemory = (memKey, number) => {
            if (memKey === 'STO') {
                state.memory[number] = parseFloat(state.currentValue);
                alert(`Valor ${state.memory[number]} armazenado no registro ${number}.`);
            } else if (memKey === 'RCL') {
                if (state.memory[number] !== null) {
                    state.currentValue = String(state.memory[number]);
                    updateDisplay.main();
                    state.isNewEntry = false;
                }
            }
            state.prefix = null;
        };

        // --- INICIALIZA√á√ÉO ---
        const init = () => {
            themeManager.init();
            updateDisplay.main();
            updateDisplay.context();

            dom.themeToggle.addEventListener('change', themeManager.toggle);
            dom.buttons.forEach(button => {
                button.addEventListener('click', () => {
                    const key = button.dataset.key;
                    const gKey = button.dataset.gKey;
                    
                    // Special handling for memory STO/RCL
                    if ((state.prefix === 'STO' || state.prefix === 'RCL') && /\d/.test(key)) {
                        handleMemory(state.prefix, parseInt(key));
                    } else {
                        handleInput(key, gKey);
                    }
                });
            });
        };

        init();
    });
    </script>
</body>
</html>
