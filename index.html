<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Calculadora Financeira Pro</title>
    <style>
        /* 1. Reset e Configura√ß√µes Globais */
        :root {
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --bg-light: #f0f2f5; --surface-light: #ffffff; --text-light: #1c1e21; --border-light: #ced0d4; --shadow-light: rgba(0, 0, 0, 0.1);
            --bg-dark: #18191a; --surface-dark: #242526; --text-dark: #e4e6eb; --border-dark: #3a3b3c; --shadow-dark: rgba(0, 0, 0, 0.4);
            --hp-blue: #2E86C1; --hp-orange: #E67E22; --hp-black: #212121;
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        body { font-family: var(--font-main); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: var(--bg-light); color: var(--text-light); transition: background-color 0.3s; -webkit-font-smoothing: antialiased; }
        body.dark-mode { background: var(--bg-dark); color: var(--text-dark); }

        /* 2. Layout da Calculadora */
        .calculator-wrapper { width: 100%; max-width: 420px; background: var(--surface-light); border-radius: 24px; box-shadow: 0 12px 40px var(--shadow-light); border: 1px solid var(--border-light); padding: 20px; margin: 15px; animation: fadeIn 0.5s ease-in-out; }
        body.dark-mode .calculator-wrapper { background: var(--surface-dark); border-color: var(--border-dark); box-shadow: 0 12px 40px var(--shadow-dark); }
        
        /* 3. Header e Controles */
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .app-header h1 { font-size: 1.5em; margin: 0; font-weight: 600; }
        .theme-switch-wrapper { display: flex; align-items: center; gap: 8px; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 44px; }
        .theme-switch input { display: none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 24px; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--hp-blue); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* 4. Display da Calculadora */
        .display-area { background: var(--hp-black); border-radius: 8px; padding: 5px; margin-bottom: 20px; }
        .display { background: #D9E0C1; color: var(--hp-black); border-radius: 4px; padding: 10px 15px; text-align: right; overflow: hidden; }
        .display-context { font-family: monospace; font-size: 0.9em; min-height: 18px; color: #555; font-weight: bold; }
        .display-main { font-family: 'DSEG7-Classic', monospace; font-size: clamp(2em, 8vw, 2.5em); font-weight: normal; min-height: 45px; word-wrap: break-word; letter-spacing: 1.5px; }
        @font-face { font-family: 'DSEG7-Classic'; src: url('https://cdn.jsdelivr.net/gh/keshikan/DSEG@v0.46/fonts/DSEG7-Classic-Bold.woff') format('woff'); }

        /* 5. Grid de Bot√µes */
        .button-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: clamp(8px, 2vw, 12px); }
        .calc-button { padding: 5px; font-weight: 600; border-radius: 12px; border: none; background: linear-gradient(145deg, #5a5a5a, #3c3c3c); color: white; cursor: pointer; transition: all 0.15s ease-out; box-shadow: 0 4px 8px rgba(0,0,0,0.2), inset 0 1px 1px rgba(255,255,255,0.1); position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: clamp(50px, 12vw, 60px); -webkit-user-select: none; user-select: none; }
        .calc-button:active { transform: scale(0.97); box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .f-label { font-size: clamp(0.6em, 2vw, 0.7em); font-weight: normal; color: var(--hp-orange); }
        .g-label { font-size: clamp(0.6em, 2vw, 0.7em); font-weight: normal; color: var(--hp-blue); }
        .main-label { font-size: clamp(1em, 3vw, 1.2em); }
        .btn-prefix-f { background: linear-gradient(145deg, #ffb74d, var(--hp-orange)); }
        .btn-prefix-g { background: linear-gradient(145deg, #64b5f6, var(--hp-blue)); }
        .btn-enter { background: linear-gradient(145deg, #78909c, #546e7a); grid-row: span 2; }
        .btn-op { background: linear-gradient(145deg, #424242, #303030); }
    </style>
</head>
<body>
    <div class="calculator-wrapper">
        <header class="app-header">
            <h1>Finance Pro</h1>
            <div class="theme-switch-wrapper">
                <span>‚òÄÔ∏è</span><label class="theme-switch"><input type="checkbox" id="theme-toggle"><span class="slider"></span></label><span>üåô</span>
            </div>
        </header>

        <div class="display-area">
            <div class="display">
                <div class="display-context" id="display-context">&nbsp;</div>
                <div class="display-main" id="display-main">0.00</div>
            </div>
        </div>

        <div class="button-grid">
            <button class="calc-button" data-key="n"><span class="main-label">n</span></button>
            <button class="calc-button" data-key="i"><span class="main-label">i</span></button>
            <button class="calc-button" data-key="PV"><span class="main-label">PV</span></button>
            <button class="calc-button" data-key="PMT"><span class="main-label">PMT</span></button>
            <button class="calc-button" data-key="FV"><span class="main-label">FV</span></button>
            
            <button class="calc-button" data-key="y^x"  data-g-key="y_root_x"><span class="g-label">y‚àöx</span><span class="main-label">y<sup>x</sup></span></button>
            <button class="calc-button" data-key="sqrt" data-g-key="x^2"><span class="g-label">x¬≤</span><span class="main-label">‚àöx</span></button>
            <button class="calc-button" data-key="ln"   data-g-key="LOG"><span class="g-label">log</span><span class="main-label">ln</span></button>
            <button class="calc-button" data-key="%"    data-f-key="CHS"><span class="f-label">+/-</span><span class="main-label">%</span></button>
            <button class="calc-button" data-key="CLx"  data-f-key="AC"><span class="f-label">AC</span><span class="main-label">CLx</span></button>

            <button class="calc-button btn-prefix-f" data-key="f"><span class="main-label">f</span></button>
            <button class="calc-button" data-key="7" data-f-key="SIN" data-g-key="CA1"><span class="f-label">sin</span><span class="g-label">ca‚ÇÅ</span><span class="main-label">7</span></button>
            <button class="calc-button" data-key="8" data-f-key="COS" data-g-key="CA2"><span class="f-label">cos</span><span class="g-label">ca‚ÇÇ</span><span class="main-label">8</span></button>
            <button class="calc-button" data-key="9" data-f-key="TAN" data-g-key="H"><span class="f-label">tan</span><span class="g-label">h</span><span class="main-label">9</span></button>
            <button class="calc-button btn-op" data-key="/"><span class="main-label">√∑</span></button>

            <button class="calc-button btn-prefix-g" data-key="g"><span class="main-label">g</span></button>
            <button class="calc-button" data-key="4" data-f-key="n!"><span class="f-label">x!</span><span class="main-label">4</span></button>
            <button class="calc-button" data-key="5"><span class="main-label">5</span></button>
            <button class="calc-button" data-key="6"><span class="main-label">6</span></button>
            <button class="calc-button btn-op" data-key="*"><span class="main-label">√ó</span></button>

            <button class="calc-button" data-key="1" data-g-key="PI"><span class="g-label">œÄ</span><span class="main-label">1</span></button>
            <button class="calc-button" data-key="2"><span class="main-label">2</span></button>
            <button class="calc-button" data-key="3"><span class="main-label">3</span></button>
            <button class="calc-button btn-op" data-key="-"><span class="main-label">‚àí</span></button>
            <button class="calc-button btn-enter" data-key="Enter"><span class="main-label">ENTER</span></button>
            
            <button class="calc-button" data-key="0" style="grid-column: span 2;"><span class="main-label">0</span></button>
            <button class="calc-button" data-key="."><span class="main-label">.</span></button>
            <button class="calc-button btn-op" data-key="+"><span class="main-label">+</span></button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const dom = {
            displayMain: document.getElementById('display-main'),
            displayContext: document.getElementById('display-context'),
            themeToggle: document.getElementById('theme-toggle'),
            buttons: document.querySelectorAll('.calc-button'),
        };

        let state;

        const resetState = () => {
            state = {
                stack: [0, 0, 0, 0], // RPN Stack: [X, Y, Z, T]
                lastX: 0,
                inputBuffer: '0',
                isEntering: true,
                prefix: null, // 'f', 'g'
                registers: { n: null, i: null, PV: null, PMT: null, FV: null },
                pythagoras: { c1: null, c2: null, h: null, count: 0},
                config: { decimalPlaces: 2 }
            };
        };
        
        const helpers = {
            factorial: (num) => {
                if (num < 0 || num % 1 !== 0) return NaN; // Factorial is for non-negative integers
                if (num === 0 || num === 1) return 1;
                let result = 1;
                for (let i = 2; i <= num; i++) {
                    result *= i;
                }
                return result;
            }
        };

        const display = {
            update: () => {
                const valueStr = state.isEntering ? state.inputBuffer : String(state.stack[0]);
                const numValue = parseFloat(valueStr.replace(',', '.'));

                if (isNaN(numValue)) {
                    dom.displayMain.textContent = "Error";
                    return;
                }

                let formattedValue;
                if (Math.abs(numValue) > 9999999999 || (Math.abs(numValue) < 0.000000001 && numValue !== 0)) {
                    formattedValue = numValue.toExponential(state.config.decimalPlaces);
                } else {
                    formattedValue = numValue.toFixed(state.config.decimalPlaces);
                }
                
                dom.displayMain.textContent = formattedValue.replace('.', ',');
            },
            updateContext: () => {
                let contextStr = '';
                if (state.prefix) {
                    const color = state.prefix === 'f' ? 'var(--hp-orange)' : 'var(--hp-blue)';
                    contextStr += `<span style="color: ${color}; font-weight: bold;">${state.prefix}</span>`;
                }
                dom.displayContext.innerHTML = contextStr || '&nbsp;';
            },
            flashMessage: (msg, duration = 1500) => {
                const originalText = dom.displayMain.textContent;
                dom.displayMain.textContent = msg;
                setTimeout(() => {
                    dom.displayMain.textContent = originalText;
                    display.update();
                }, duration);
            }
        };

        const rpn = {
            push: (value) => {
                if (isNaN(value)) { 
                    display.flashMessage("Error");
                    value = 0; 
                }
                state.lastX = state.stack[0];
                state.stack.unshift(value);
                state.stack.pop();
            },
            pop: () => {
                const x = state.stack.shift();
                state.stack.push(state.stack[2]); // T replicates
                return x;
            },
            enter: () => {
                if (state.isEntering) {
                    rpn.push(parseFloat(state.inputBuffer.replace(',', '.')));
                    state.isEntering = false;
                } else {
                    rpn.push(state.stack[0]); // Duplicate X
                }
            },
            binaryOp: (op) => {
                if (state.isEntering) rpn.enter();
                const x = rpn.pop();
                const y = rpn.pop();
                rpn.push(op(y, x));
            },
            unaryOp: (op) => {
                if (state.isEntering) rpn.enter();
                const x = rpn.pop();
                rpn.push(op(x));
            }
        };

        const engine = {
            tvm: (key) => {
                const { n, i, PV, PMT, FV } = state.registers;
                const i_dec = (i || 0) / 100;
                let result = NaN;

                try {
                    switch(key) {
                        case 'FV': result = -(PV * Math.pow(1 + i_dec, n) + (PMT || 0) * ((Math.pow(1 + i_dec, n) - 1) / i_dec)); break;
                        case 'PV': result = -(FV / Math.pow(1 + i_dec, n) + (PMT || 0) * ((1 - Math.pow(1 + i_dec, -n)) / i_dec)); break;
                        case 'n': result = Math.log((-FV + (PMT/i_dec)) / (PV + (PMT/i_dec))) / Math.log(1 + i_dec); break;
                        case 'i': // Simplified; a real one needs an iterative solver
                           result = (Math.pow(FV / -PV, 1/n) - 1) * 100;
                           if (isNaN(result)) display.flashMessage("Needs PV/FV");
                           break;
                        case 'PMT': result = -(PV + FV / Math.pow(1 + i_dec, n)) * (i_dec / (1 - Math.pow(1 + i_dec, -n))); break;
                    }
                } catch (e) {
                    display.flashMessage("Calc Error");
                    return;
                }
                
                if (isNaN(result)) {
                   const filledCount = Object.values(state.registers).filter(v => v !== null).length;
                   display.flashMessage(`${4 - filledCount} more`);
                } else {
                    rpn.push(result);
                }
            },
            pythagoras: (key) => {
                const p = state.pythagoras;
                if(state.isEntering) rpn.enter();
                
                p[key] = state.stack[0];
                p.count++;
                display.flashMessage(`${key.toUpperCase()} set`);

                if (p.count >= 2) {
                    let result = NaN;
                    try {
                        if (key === 'h' && p.c1 && p.c2) result = Math.sqrt(p.c1**2 + p.c2**2);
                        else if (key === 'c1' && p.h && p.c2) result = Math.sqrt(p.h**2 - p.c2**2);
                        else if (key === 'c2' && p.h && p.c1) result = Math.sqrt(p.h**2 - p.c1**2);
                    } catch(e) { result = NaN; }
                    
                    if (!isNaN(result)) {
                        rpn.push(result);
                        p.c1 = p.c2 = p.h = null;
                        p.count = 0;
                    }
                }
            }
        };

        const handle = {
            key: (button) => {
                const key = button.dataset.key;
                const fKey = button.dataset.fKey;
                const gKey = button.dataset.gKey;

                if (state.prefix === 'f' && fKey) {
                    handle.func(fKey);
                    state.prefix = null;
                } else if (state.prefix === 'g' && gKey) {
                    handle.func(gKey);
                    state.prefix = null;
                } else {
                    // Special case for f-prefix + number for setting decimal places
                    if (state.prefix === 'f' && "0123456789".includes(key)) {
                        state.config.decimalPlaces = parseInt(key);
                        display.flashMessage(`FIX ${key}`);
                        state.prefix = null;
                    } else {
                       handle.func(key);
                    }
                }
                display.update();
                display.updateContext();
            },
            number: (digit) => {
                if (!state.isEntering) {
                    rpn.enter(); // Push X to Y
                    state.inputBuffer = '0';
                    state.isEntering = true;
                }
                if (state.inputBuffer.length > 12) return;
                if (digit === '.' && state.inputBuffer.includes(',')) return;
                
                if (state.inputBuffer === '0' && digit !== '.') state.inputBuffer = '';
                state.inputBuffer += (digit === '.' ? ',' : digit);
            },
            func: (key) => {
                const numericKeys = "0123456789.";
                if (numericKeys.includes(key)) {
                    handle.number(key);
                    return;
                }
                
                if (state.isEntering && key !== 'Enter' && key !== 'CHS' && key !== 'CLx') {
                    rpn.enter();
                }
                state.isEntering = false;

                switch (key) {
                    // System & Stack
                    case 'Enter': rpn.enter(); state.isEntering = false; break;
                    case 'CHS':
                        if(state.isEntering && state.inputBuffer !== '0') {
                            state.inputBuffer = String(-parseFloat(state.inputBuffer.replace(',','.'))).replace('.',',');
                        } else {
                            rpn.unaryOp(x => -x);
                        }
                        break;
                    case 'CLx': state.inputBuffer = '0'; state.isEntering = true; state.stack[0] = 0; break;
                    case 'AC': resetState(); break;
                    case 'f': case 'g': state.prefix = key; break;
                    
                    // Basic Arithmetic
                    case '+': rpn.binaryOp((y, x) => y + x); break;
                    case '-': rpn.binaryOp((y, x) => y - x); break;
                    case '*': rpn.binaryOp((y, x) => y * x); break;
                    case '/': rpn.binaryOp((y, x) => y / x); break;
                    case '%': rpn.binaryOp((y, x) => (y * x) / 100); break;

                    // Scientific
                    case 'y^x':  rpn.binaryOp((y, x) => Math.pow(y, x)); break;
                    case 'sqrt': rpn.unaryOp(x => Math.sqrt(x)); break;
                    case 'x^2':  rpn.unaryOp(x => x * x); break;
                    case 'ln':   rpn.unaryOp(x => Math.log(x)); break;
                    case 'LOG':  rpn.binaryOp((y, x) => Math.log(y) / Math.log(x)); break;
                    case 'y_root_x': rpn.binaryOp((y, x) => Math.pow(y, 1/x)); break;
                    case 'n!':   rpn.unaryOp(x => helpers.factorial(x)); break;
                    case 'PI':   rpn.push(Math.PI); break;
                    
                    // Trigonometry (assuming input in radians)
                    case 'SIN': rpn.unaryOp(x => Math.sin(x)); break;
                    case 'COS': rpn.unaryOp(x => Math.cos(x)); break;
                    case 'TAN': rpn.unaryOp(x => Math.tan(x)); break;

                    // Financial
                    case 'n': case 'i': case 'PV': case 'PMT': case 'FV':
                        if (state.isEntering || !state.registers[key]) {
                            state.registers[key] = state.stack[0];
                            display.flashMessage(`${key} set`);
                        } else {
                            engine.tvm(key);
                        }
                        break;
                        
                    // Pythagorean
                    case 'CA1': engine.pythagoras('c1'); break;
                    case 'CA2': engine.pythagoras('c2'); break;
                    case 'H':   engine.pythagoras('h'); break;
                    
                    default: display.flashMessage("N/I");
                }
            }
        };

        const initApp = () => {
            resetState();
            display.update();
            display.updateContext();
            
            dom.buttons.forEach(button => {
                button.addEventListener('click', () => handle.key(button));
            });

            dom.themeToggle.addEventListener('change', () => {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('FinanceProTheme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            });

            if (localStorage.getItem('FinanceProTheme') === 'dark') {
                document.body.classList.add('dark-mode');
                dom.themeToggle.checked = true;
            }
            
            // Keyboard Support
            document.addEventListener('keydown', (e) => {
                let key = e.key;
                if(key === 'Enter' || key === 'NumpadEnter') { e.preventDefault(); handle.func('Enter'); }
                if(key >= '0' && key <= '9') { handle.number(key); }
                if(key === '.' || key === ',') { handle.number('.'); }
                if(key === 'Backspace') { handle.func('CLx'); }
                if(key === '+') { handle.func('+'); }
                if(key === '-') { handle.func('-'); }
                if(key === '*') { handle.func('*'); }
                if(key === '/') { e.preventDefault(); handle.func('/'); }
                if(key.toLowerCase() === 'f') { handle.func('f'); }
                if(key.toLowerCase() === 'g') { handle.func('g'); }
                display.update();
                display.updateContext();
            });
        };

        initApp();
    });
    </script>
</body>
</html>
