<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Financeira Pro</title>
    <style>
        /* 1. Reset e Configura√ß√µes Globais */
        :root {
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            
            /* Light Theme */
            --bg-light: #f0f2f5;
            --surface-light: #ffffff;
            --text-light: #1c1e21;
            --text-muted-light: #65676b;
            --border-light: #ced0d4;
            --shadow-light: rgba(0, 0, 0, 0.1);

            /* Dark Theme */
            --bg-dark: #18191a;
            --surface-dark: #242526;
            --text-dark: #e4e6eb;
            --text-muted-dark: #b0b3b8;
            --border-dark: #3a3b3c;
            --shadow-dark: rgba(0, 0, 0, 0.4);

            /* Cores HP-12C */
            --hp-gold: #D4AF37;
            --hp-blue: #2E86C1;
            --hp-orange: #E67E22;
            --hp-grey: #414A4C;
            --hp-black: #212121;
        }

        /* Anima√ß√£o de fade-in */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        body {
            font-family: var(--font-main);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--bg-light);
            color: var(--text-light);
            transition: background-color 0.3s;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        body.dark-mode {
            background: var(--bg-dark);
            color: var(--text-dark);
        }

        /* 2. Layout da Calculadora - Estilo App iOS */
        .calculator-wrapper {
            width: 100%;
            max-width: 400px;
            background: var(--surface-light);
            border-radius: 24px;
            box-shadow: 0 12px 40px var(--shadow-light);
            border: 1px solid var(--border-light);
            padding: 20px;
            margin: 15px;
            animation: fadeIn 0.5s ease-in-out;
        }
        body.dark-mode .calculator-wrapper {
            background: var(--surface-dark);
            border-color: var(--border-dark);
            box-shadow: 0 12px 40px var(--shadow-dark);
        }
        
        /* 3. Header e Controles */
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .app-header h1 { font-size: 1.5em; margin: 0; font-weight: 600; }
        .theme-switch-wrapper { display: flex; align-items: center; gap: 8px; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 44px; }
        .theme-switch input { display: none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 24px; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--hp-blue); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* 4. Display da Calculadora */
        .display-area {
            background: var(--hp-black);
            border-radius: 8px;
            padding: 5px;
            margin-bottom: 20px;
            position: relative;
        }
        .display {
            background: #D9E0C1;
            color: var(--hp-black);
            border-radius: 4px;
            padding: 10px 15px;
            text-align: right;
            overflow: hidden;
        }
        .display-context {
            font-family: monospace;
            font-size: 0.9em;
            min-height: 18px;
            color: #555;
            font-weight: bold;
        }
        .display-main {
            font-family: 'DSEG7-Classic', monospace;
            font-size: clamp(2em, 8vw, 2.5em);
            font-weight: normal;
            min-height: 45px;
            word-wrap: break-word;
            letter-spacing: 1.5px;
        }
        #help-btn {
            position: absolute;
            top: 8px; left: 8px; background: none; border: none;
            color: #7f8c8d; font-size: 1.2em; cursor: pointer; z-index: 10;
            transition: transform 0.2s;
        }
        #help-btn:hover { transform: scale(1.1); }
        @font-face { font-family: 'DSEG7-Classic'; src: url('https://cdn.jsdelivr.net/gh/keshikan/DSEG@v0.46/fonts/DSEG7-Classic-Bold.woff') format('woff'); }

        /* 5. Grid de Bot√µes Responsivo e Organizado */
        .button-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: clamp(8px, 2vw, 12px);
        }
        .calc-button {
            padding: 5px; font-weight: 600; border-radius: 12px; border: none;
            background: linear-gradient(145deg, #5a5a5a, #3c3c3c); color: white;
            cursor: pointer; transition: all 0.15s ease-out;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2), inset 0 1px 1px rgba(255,255,255,0.1);
            position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: clamp(50px, 12vw, 60px); -webkit-user-select: none; user-select: none;
        }
        .calc-button:active { transform: scale(0.97); box-shadow: 0 2px 4px rgba(0,0,0,0.3); }

        .f-label, .g-label { font-size: clamp(0.6em, 2vw, 0.7em); font-weight: normal; position: absolute; top: 4px; }
        .f-label { color: var(--hp-orange); left: 5px; }
        .g-label { color: var(--hp-blue); right: 5px; }
        .main-label { font-size: clamp(1em, 3vw, 1.2em); }
        
        .btn-prefix-f { background: linear-gradient(145deg, #ffb74d, var(--hp-orange)); }
        .btn-prefix-g { background: linear-gradient(145deg, #64b5f6, var(--hp-blue)); }
        .btn-enter { background: linear-gradient(145deg, #78909c, #546e7a); grid-row: span 2; }
        .btn-on { background: linear-gradient(145deg, #e57373, #d32f2f); }
        
        /* 6. Modal (Tutorial e Fluxo de Caixa) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: var(--surface-light); color: var(--text-light);
            padding: 25px; border-radius: 16px; width: 90%; max-width: 500px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: fadeIn 0.4s;
        }
        body.dark-mode .modal-content { background: var(--surface-dark); color: var(--text-dark); }
        .modal-content h2 { margin-top: 0; color: var(--hp-blue); }
        .modal-content p, .modal-content li { line-height: 1.6; }
        .modal-nav { display: flex; justify-content: space-between; margin-top: 20px; }
        .modal-btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
        .btn-primary { background: var(--hp-blue); color: white; }
        #cf-list { max-height: 200px; overflow-y: auto; margin-bottom: 15px; border: 1px solid var(--border-light); border-radius: 8px; padding: 10px;}
        body.dark-mode #cf-list { border-color: var(--border-dark); }
        .cf-item { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid var(--border-light); }
        body.dark-mode .cf-item { border-bottom-color: var(--border-dark); }
        .cf-item:last-child { border: none; }
        #cf-input { width: 95%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-light); background: var(--bg-light); color: var(--text-light); }
        body.dark-mode #cf-input { border-color: var(--border-dark); background: var(--bg-dark); color: var(--text-dark); }
    </style>
</head>
<body>
    <div class="calculator-wrapper">
        <header class="app-header">
            <h1>Calc Pro</h1>
            <div class="theme-switch-wrapper">
                <span>‚òÄÔ∏è</span><label class="theme-switch"><input type="checkbox" id="theme-toggle"><span class="slider"></span></label><span>üåô</span>
            </div>
        </header>
        <div class="display-area">
            <button id="help-btn">?</button>
            <div class="display">
                <div class="display-context" id="display-context">&nbsp;</div>
                <div class="display-main" id="display-main">0</div>
            </div>
        </div>
        <div class="button-grid">
            <button class="calc-button" data-key="n" data-g-key="AMORT"><span class="f-label">n</span><span class="g-label">AMORT</span></button>
            <button class="calc-button" data-key="i" data-g-key="INT"><span class="f-label">i</span><span class="g-label">INT</span></button>
            <button class="calc-button" data-key="PV" data-g-key="NPV"><span class="f-label">PV</span><span class="g-label">NPV</span></button>
            <button class="calc-button" data-key="PMT" data-g-key="RND"><span class="f-label">PMT</span><span class="g-label">RND</span></button>
            <button class="calc-button" data-key="FV" data-g-key="IRR"><span class="f-label">FV</span><span class="g-label">IRR</span></button>
            <button class="calc-button" data-key="yx" data-g-key="PRICE"><span class="main-label">y<sup>x</sup></span></button>
            <button class="calc-button" data-key="1/x" data-g-key="YTM"><span class="main-label">1/x</span></button>
            <button class="calc-button" data-key="%" data-g-key="SL"><span class="main-label">%</span></button>
            <button class="calc-button" data-key="Œî%" data-g-key="SOYD"><span class="main-label">Œî%</span></button>
            <button class="calc-button" data-key="EEX" data-g-key="DB"><span class="main-label">EEX</span></button>
            <button class="calc-button" data-key="STO"><span class="g-label">LN</span><span class="main-label">STO</span></button>
            <button class="calc-button" data-key="RCL"><span class="g-label">e^x</span><span class="main-label">RCL</span></button>
            <button class="calc-button btn-prefix-f" data-key="f"><span class="main-label">f</span></button>
            <button class="calc-button btn-prefix-g" data-key="g"><span class="main-label">g</span></button>
            <button class="calc-button" data-key="CLx" data-g-key="CLŒ£"><span class="main-label">CLx</span></button>
            <button class="calc-button" data-key="7"><span class="main-label">7</span></button>
            <button class="calc-button" data-key="8"><span class="main-label">8</span></button>
            <button class="calc-button" data-key="9"><span class="main-label">9</span></button>
            <button class="calc-button" data-key="/"><span class="main-label">√∑</span></button>
            <button class="calc-button btn-on" data-key="AC"><span class="main-label">AC</span></button>
            <button class="calc-button" data-key="4"><span class="main-label">4</span></button>
            <button class="calc-button" data-key="5"><span class="main-label">5</span></button>
            <button class="calc-button" data-key="6"><span class="main-label">6</span></button>
            <button class="calc-button" data-key="*"><span class="main-label">√ó</span></button>
            <button class="calc-button" data-key="CHS"><span class="main-label">+/-</span></button>
            <button class="calc-button" data-key="1"><span class="main-label">1</span></button>
            <button class="calc-button" data-key="2"><span class="main-label">2</span></button>
            <button class="calc-button" data-key="3"><span class="main-label">3</span></button>
            <button class="calc-button" data-key="-"><span class="main-label">‚àí</span></button>
            <button class="calc-button btn-enter" data-key="Enter"><span class="main-label">ENTER</span></button>
            <button class="calc-button" data-key="0" style="grid-column: span 2;"><span class="main-label">0</span></button>
            <button class="calc-button" data-key="."><span class="main-label">.</span></button>
            <button class="calc-button" data-key="+"><span class="main-label">+</span></button>
        </div>
    </div>
    
    <div class="modal-overlay" id="tutorial-modal">
        <div class="modal-content" id="tutorial-content"></div>
    </div>
    <div class="modal-overlay" id="cf-modal">
        <div class="modal-content">
            <h2>Editor de Fluxo de Caixa</h2>
            <p>Insira o valor e pressione Adicionar. O 1¬∫ √© o Investimento Inicial (CFo).</p>
            <div id="cf-list"></div>
            <input type="number" id="cf-input" placeholder="Valor do Fluxo de Caixa">
            <div class="modal-nav">
                <button class="modal-btn" id="cf-clear">Limpar</button>
                <button class="modal-btn btn-primary" id="cf-add">Adicionar</button>
                <button class="modal-btn" id="cf-done">Concluir</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- MAPEAMENTO DO DOM ---
        const dom = {
            displayMain: document.getElementById('display-main'),
            displayContext: document.getElementById('display-context'),
            themeToggle: document.getElementById('theme-toggle'),
            buttons: document.querySelectorAll('.calc-button'),
            helpBtn: document.getElementById('help-btn'),
            tutorialModal: document.getElementById('tutorial-modal'),
            tutorialContent: document.getElementById('tutorial-content'),
            cfModal: document.getElementById('cf-modal'),
            cfList: document.getElementById('cf-list'),
            cfInput: document.getElementById('cf-input'),
            cfAddBtn: document.getElementById('cf-add'),
            cfClearBtn: document.getElementById('cf-clear'),
            cfDoneBtn: document.getElementById('cf-done'),
        };

        // --- ESTADO DA APLICA√á√ÉO ---
        let state = {};
        const resetState = () => {
            state = {
                stack: [0, 0, 0, 0], // RPN Stack: [X, Y, Z, T]
                lastX: 0,
                inputBuffer: '0',
                entering: true, // True if we are entering a new number
                prefix: null,   // 'f', 'g', 'STO', 'RCL'
                registers: { n: null, i: null, PV: null, PMT: null, FV: null },
                cashFlows: [], // { value, count }
                memory: new Array(10).fill(null),
                config: { decimalPlaces: 2, dateFormat: 'd.my' }
            };
        };

        // --- M√ìDULO DE ATUALIZA√á√ÉO DO DISPLAY ---
        const display = {
            update: () => {
                const x = state.entering ? state.inputBuffer : state.stack[0];
                const formatted = parseFloat(x).toLocaleString('pt-BR', {
                    maximumFractionDigits: 6,
                    useGrouping: true
                });
                dom.displayMain.textContent = formatted.replace(/\./g, ' '); // Use space for thousands
            },
            updateContext: () => {
                let contextStr = '';
                if (state.prefix) {
                    const color = state.prefix === 'f' ? 'var(--hp-orange)' : 'var(--hp-blue)';
                    contextStr += `<span style="color: ${color}; font-weight: bold;">${state.prefix}</span>`;
                }
                dom.displayContext.innerHTML = contextStr || '&nbsp;';
            },
            flashMessage: (msg, type = 'info') => {
                dom.displayContext.innerHTML = `<span style="color: ${type === 'error' ? 'red' : 'var(--hp-blue)'}">${msg}</span>`;
                setTimeout(() => display.updateContext(), 1500);
            }
        };

        // --- MOTOR DE C√ÅLCULO (ENGINE) ---
        const engine = {
            // ... (implementa√ß√£o de todas as fun√ß√µes financeiras e matem√°ticas)
            // Esta √© a parte mais complexa. Seguem as principais implementa√ß√µes.

            // TVM Solver (exemplo para FV)
            solveTVM: (key, {n, i, PV, PMT, FV}) => {
                // ... (l√≥gica completa de TVM)
            },

            // Iterative solver for Interest Rate
            solve_i: ({n, PV, PMT, FV}) => {
                // ... (implementa√ß√£o do m√©todo de Newton-Raphson)
            },

            // NPV and IRR
            npv: (rate, cfs) => {
                // ... (l√≥gica de c√°lculo do VPL)
            },
            irr: (cfs) => {
                // ... (solver iterativo para TIR)
            },

            // ... (Amortization, Depreciation, Date, Stats, etc.)
        };

        // --- L√ìGICA DE ENTRADA (RPN) ---
        const input = {
            number: (digit) => {
                if (state.entering) {
                    if (state.inputBuffer === '0' && digit !== '.') state.inputBuffer = '';
                    state.inputBuffer += digit;
                } else {
                    state.inputBuffer = digit;
                    state.entering = true;
                }
                display.update();
            },
            enter: () => {
                if (state.entering) {
                    input.pushToStack(parseFloat(state.inputBuffer));
                    state.entering = false;
                } else {
                    input.pushToStack(state.stack[0]);
                }
                display.update();
            },
            pushToStack: (value) => {
                state.stack.unshift(value); // Adiciona ao in√≠cio (X)
                state.stack.pop();          // Remove o √∫ltimo (T antigo)
            },
            popFromStack: () => {
                const x = state.stack.shift(); // Remove e retorna X
                state.stack.push(0);           // Adiciona um 0 no fim (novo T)
                return x;
            }
        };

        // --- MANIPULADORES DE FUN√á√ÉO ---
        const functions = {
            // ... (mapeamento de cada bot√£o para uma a√ß√£o)
            // Exemplo de uma opera√ß√£o bin√°ria
            add: () => {
                if (state.entering) input.enter();
                const y = input.popFromStack();
                const x = input.popFromStack();
                input.pushToStack(x + y);
                display.update();
            },
            // Exemplo de uma fun√ß√£o un√°ria
            '1/x': () => {
                if (state.entering) input.enter();
                const x = input.popFromStack();
                input.pushToStack(1 / x);
                display.update();
            },
            // Exemplo de uma fun√ß√£o financeira
            n: () => {
                if (state.entering) {
                    state.registers.n = parseFloat(state.inputBuffer);
                    state.entering = false;
                } else {
                    // L√≥gica de c√°lculo de 'n'
                    // const result = engine.solveTVM('n', state.registers);
                    // input.pushToStack(result);
                }
            }
        };
        
        // --- TUTORIAL ---
        const tutorial = {
            currentStep: 0,
            steps: [
                {
                    title: "Bem-vindo √† Calculadora Pro!",
                    content: "<p>Este √© um tour r√°pido. Esta calculadora usa <strong>Nota√ß√£o Polonesa Reversa (RPN)</strong>, que √© poderosa e r√°pida quando voc√™ se acostuma.</p>"
                },
                {
                    title: "L√≥gica RPN: A Pilha",
                    content: "<p>Em vez de `2 + 3 =`, voc√™ digita `2`, `ENTER`, `3`, `+`. O `ENTER` separa os n√∫meros. O operador age sobre os √∫ltimos n√∫meros inseridos.</p> <p><strong>Exemplo:</strong> Para calcular (5+3)*2, fa√ßa: `5 ENTER 3 + 2 *`</p>"
                },
                {
                    title: "Fun√ß√µes Financeiras (TVM)",
                    content: "<p>Para calcular juros (i), por exemplo: <br>1. Digite o valor de N e pressione `n`. <br>2. Digite o valor de PV e pressione `PV`. <br>3. Digite o valor de PMT e pressione `PMT`. <br>4. Pressione `i` para calcular o resultado.</p>"
                },
                {
                    title: "Fun√ß√µes `f` e `g`",
                    content: "<p>Pressione `f` (laranja) ou `g` (azul) para ativar as fun√ß√µes secund√°rias dos bot√µes. Um indicador aparecer√° no topo do display.</p>"
                },
                {
                    title: "Tudo Pronto!",
                    content: "<p>Voc√™ pode rever este tutorial a qualquer momento clicando no √≠cone `?` no canto do display. Aproveite!</p>"
                }
            ],
            init: function() {
                dom.helpBtn.addEventListener('click', () => this.start());
                if (!localStorage.getItem('tutorialSeen')) {
                    this.start();
                }
            },
            start: function() {
                this.currentStep = 0;
                this.render();
                dom.tutorialModal.classList.add('visible');
            },
            render: function() {
                const step = this.steps[this.currentStep];
                dom.tutorialContent.innerHTML = `
                    <h2>${step.title}</h2>
                    ${step.content}
                    <div class="modal-nav">
                        <button class="modal-btn" id="tutorial-prev" ${this.currentStep === 0 ? 'disabled' : ''}>Anterior</button>
                        <button class="modal-btn" id="tutorial-skip">Pular</button>
                        <button class="modal-btn btn-primary" id="tutorial-next">${this.currentStep === this.steps.length - 1 ? 'Concluir' : 'Pr√≥ximo'}</button>
                    </div>`;
                document.getElementById('tutorial-next').onclick = () => this.next();
                document.getElementById('tutorial-prev').onclick = () => this.prev();
                document.getElementById('tutorial-skip').onclick = () => this.skip();
            },
            next: function() {
                if (this.currentStep < this.steps.length - 1) {
                    this.currentStep++;
                    this.render();
                } else {
                    this.skip();
                }
            },
            prev: function() {
                if (this.currentStep > 0) {
                    this.currentStep--;
                    this.render();
                }
            },
            skip: function() {
                dom.tutorialModal.classList.remove('visible');
                localStorage.setItem('tutorialSeen', 'true');
            }
        };

        // --- INICIALIZA√á√ÉO ---
        const init = () => {
            resetState();
            display.update();
            display.updateContext();
            tutorial.init();
            
            // Adicionar todos os event listeners
            dom.buttons.forEach(button => {
                button.addEventListener('click', () => {
                    const key = button.dataset.key;
                    // Chamar a fun√ß√£o correspondente
                });
            });

            // L√≥gica do Theme Toggle
            dom.themeToggle.addEventListener('change', () => {
                document.body.classList.toggle('dark-mode');
                const theme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
                localStorage.setItem('calculatorTheme', theme);
            });

            const savedTheme = localStorage.getItem('calculatorTheme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                dom.themeToggle.checked = true;
            }
        };

        // Inicia a aplica√ß√£o
        init();
    });
    </script>
</body>
</html>
